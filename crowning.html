<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tribute Game â€“ Crown Your Team</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBd3CpowxCtVvnqV5MlyN-t0jVEMvDTXgo",
      authDomain: "tributegame-5b871.firebaseapp.com",
      projectId: "tributegame-5b871",
      storageBucket: "tributegame-5b871.appspot.com",
      messagingSenderId: "757938343666",
      appId: "1:757938343666:web:aa5f13826b0e360b0a8a6b",
      measurementId: "G-5SDNERCN2D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.settings({ experimentalForceLongPolling: true, useFetchStreams: false });
  </script>

  <style>
    :root { --primary:#2563eb; --muted:#6b7280; --danger:#dc2626; --bg:#f7fafc; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { font-family: Arial, sans-serif; background:var(--bg); margin:0; }
    header { background:#0f172a; color:#fff; padding:16px 24px; }
    h1 { margin:0; font-size:22px; }
    main { max-width:1200px; margin:24px auto; background:#fff; padding:24px; border-radius:12px; box-shadow:0 4px 18px rgba(0,0,0,0.08);}

    /* instructions */
    .instructions { margin: 0 0 12px 18px; color:#374151; }
    .instructions li { margin: 6px 0; }

    /* 75 / 25 layout that expands to full */
    .layout { display:grid; grid-template-columns: 3fr 1fr; gap:16px; align-items:start; }
    .layout.full { grid-template-columns: 1fr; }

    /* left: members grid */
    .grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:14px; }
    .member-box { border:2px dashed #cbd5e1; border-radius:12px; padding:10px; min-height:140px; background:#f8fafc; transition: border-color .2s, box-shadow .2s; }
    .member-header { font-weight:bold; margin-bottom:8px; color:#0f172a; }
    .dropzone { min-height:72px; display:flex; flex-wrap:wrap; gap:6px; align-items: flex-start; }
    .chip { background:#e0f2fe; border:1px solid #7dd3fc; color:#0c4a6e; padding:6px 10px; border-radius:9999px; display:inline-flex; align-items:center; cursor:grab; }
    /* Ensure chips inside member boxes never expand full width */
    .dropzone .chip { display:inline-flex !important; flex: 0 0 auto; line-height: 1.2; padding: 6px 10px; }
    .box-highlight { border-color:#16a34a; box-shadow:0 0 0 3px rgba(22,163,74,0.15); }

    /* right: titles list */
    .sidebar { border-left:1px solid #e5e7eb; padding-left:12px; }
    .sidebar h3 { margin:4px 0 10px; }
    .pool-list { overflow:auto; height: 90vh; border:2px dashed #cbd5e1; border-radius:10px; padding:10px; background:#f1f5f9; display:flex; flex-direction:column; gap:8px; }
    .pool-row { display:block; } /* one title per row in sidebar */

    /* controls */
    .controls { display:flex; flex-wrap:wrap; gap:10px; margin-top:16px; }
    button { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-secondary { background:var(--muted); color:#fff; }
    .btn-danger { background:var(--danger); color:#fff; }
    .hidden { display:none !important; }
    .small { color:#334155; font-size:13px; }

    .result-list { margin-top:8px; }
    .title-count { display:flex; justify-content:space-between; padding:6px 10px; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; margin:4px 0; }

    /* spinner + toast */
    .spinner { width:20px; height:20px; border:3px solid #e5e7eb; border-top-color:var(--primary); border-radius:50%; animation: spin 1s linear infinite; display:none; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #111827; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.2); display: none; z-index: 9999; max-width: calc(100vw - 40px); text-align: center;}
  </style>
</head>
<body>
  <header><h1>Crown Your Team</h1></header>

  <main>
    <ul class="instructions">
      <li>This is in anonymous mode; the app doesn't know who you are.</li>
      <li>Choose a crown (title) on the right and give it to the most fitting teammate.</li>
      <li>Each teammate must have at least one crown. You can skip yourself.</li>
      <li>After crowning all, click on 'Submit'.</li>
    </ul>

    <div class="layout" id="layout">
      <!-- Left: members -->
      <section>
        <div id="members" class="grid"></div>

        <div class="controls">
          <button id="submitAssign" class="btn-primary">Submit</button>
          <div id="spinner" class="spinner"></div>
          <button id="unlockResults" class="btn-secondary">Unlock Results</button>
          <button id="showNext" class="btn-secondary hidden">Next Member Result</button>
          <button id="clearAll" class="btn-danger">Clear All</button>
        </div>
      </section>

      <!-- Right: titles list -->
      <aside id="sidebar" class="sidebar">
        <h3>Available Crowns</h3>
        <div id="pool" class="pool-list"></div>
      </aside>
    </div>
  </main>

  <div id="toast">Crowning done successfully!</div>

  <script>
    const TEAM_MEMBERS = [
      "Sudhi","Robert","Tim","Rishabh","Aditya","Raunit","Mangesh",
      "Rashmith","Prasanta","Haripriya","Kashika","Akanksha","Vivek",
      "Nirmal","Kewal"
    ];

    // drag state
    let draggedEl = null;
    let resultsMode = false;
    let unlocked = false;
    const revealed = new Set();
    const memberBoxByName = new Map();

    // elements
    const poolZone = document.getElementById('pool');
    const membersGrid = document.getElementById('members');
    const submitAssignBtn = document.getElementById('submitAssign');
    const unlockBtn = document.getElementById('unlockResults');
    const showNextBtn = document.getElementById('showNext');
    const clearAllBtn = document.getElementById('clearAll');
    const sidebar = document.getElementById('sidebar');
    const spinner = document.getElementById('spinner');
    const toast = document.getElementById('toast');
    const layout = document.getElementById('layout');

    // utils
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
    function showToast(msg='Titles submitted'){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2000); }
    function setSpinning(on){ spinner.style.display = on ? 'inline-block' : 'none'; }

    // Dynamically size the right list to bottom of viewport
    function sizeSidebar(){
      if(!poolZone || poolZone.offsetParent === null) return; // hidden
      const rect = poolZone.getBoundingClientRect();
      const maxH = Math.max(120, Math.floor(window.innerHeight - rect.top - 16));
      poolZone.style.maxHeight = maxH + 'px';
    }
    window.addEventListener('resize', sizeSidebar);

    // DnD
    function createChip(text){
      const chip = document.createElement('span');
      chip.className = 'chip pool-row';          // block in sidebar
      chip.textContent = text;
      chip.draggable = true;
      chip.addEventListener('dragstart', (e)=>{ if(resultsMode) return; draggedEl=chip; e.dataTransfer.setData('text/plain', text); });
      chip.addEventListener('dragend', ()=>{ draggedEl=null; });
      return chip;
    }
    function makeDropzone(zone){
      zone.addEventListener('dragover', (e)=>{ if(resultsMode) return; e.preventDefault(); });
      zone.addEventListener('drop', (e)=>{
        if(resultsMode) return;
        e.preventDefault();
        if(!draggedEl) return;
        zone.appendChild(draggedEl);

        // >>> FIX: chips in member boxes shouldn't be full-width
        if(zone === poolZone){
          draggedEl.classList.add('pool-row');   // one-per-row in sidebar
        }else{
          draggedEl.classList.remove('pool-row'); // inline pills in dropzones
        }
      });
    }

    function renderMembers(){
      membersGrid.innerHTML = '';
      memberBoxByName.clear();
      shuffle([...TEAM_MEMBERS]).forEach(name=>{
        const box = document.createElement('div');
        box.className = 'member-box';
        box.dataset.member = name;

        const header = document.createElement('div');
        header.className = 'member-header';
        header.textContent = name;

        const dz = document.createElement('div');
        dz.className = 'dropzone';
        makeDropzone(dz);

        const resultWrap = document.createElement('div');
        resultWrap.className = 'result-list hidden';

        box.appendChild(header);
        box.appendChild(dz);
        box.appendChild(resultWrap);

        membersGrid.appendChild(box);
        memberBoxByName.set(name, box);
      });
      makeDropzone(poolZone);
      sizeSidebar();
    }

    async function loadTitles(){
      const snap = await db.collection('titles').get();
      const map = new Map();
      snap.forEach(doc=>{
        const t = (doc.data().text||'').trim();
        if(!t) return;
        const key = t.toLowerCase();
        if(!map.has(key)) map.set(key, t);
      });
      const arr = Array.from(map.values()).sort((a,b)=>a.localeCompare(b));
      poolZone.innerHTML = '';
      arr.forEach(t=> poolZone.appendChild(createChip(t)));
      sizeSidebar();
    }

    function getAssignments(){
      const boxes = membersGrid.querySelectorAll('.member-box');
      const res = new Map();
      boxes.forEach(box=>{
        const name = box.dataset.member;
        const titles = Array.from(box.querySelectorAll('.dropzone .chip')).map(c=>c.textContent);
        res.set(name, titles);
      });
      return res;
    }

    function validateBeforeSubmit() {
      const assignMap = getAssignments();
      const total = TEAM_MEMBERS.length;
      const empty = [];
    
      for (const [member, titles] of assignMap.entries()) {
        if (!titles.length) empty.push(member);
      }
    
      // allow at most one empty box
      return { ok: empty.length <= 1, empty };
    }

    submitAssignBtn.addEventListener('click', async ()=>{
      const check = validateBeforeSubmit();
      if (!check.ok) {
        const preview = check.empty.slice(0, 4).join(', ');
        const more = check.empty.length > 4 ? ` +${check.empty.length - 4} more` : '';
        alert(`Please crown at least ${TEAM_MEMBERS.length - 1} teammates (you can skip yourself). Missing: ${preview}${more}`);
        return;
      }
      setSpinning(true);
      submitAssignBtn.disabled = true;

      const assignMap = getAssignments();
      try{
        const batch = db.batch();
        const now = new Date();
        for(const [member,titles] of assignMap.entries()){
          titles.forEach(title=>{
            const ref = db.collection('assignments').doc();
            batch.set(ref, { member, title, submittedAt: now });
          });
        }
        await batch.commit();

        showToast('Titles submitted');
        renderMembers();
        await loadTitles();
      }catch(err){
        console.error(err);
        alert('Error submitting assignments: ' + err.message);
      }finally{
        setSpinning(false);
        submitAssignBtn.disabled = false;
      }
    });

    // Results mode
    function enterResultsMode(){
      resultsMode = true;
      sidebar.classList.add('hidden');
      layout.classList.add('full');
      unlockBtn.classList.add('hidden');
      submitAssignBtn.classList.add('hidden');
      showNextBtn.classList.remove('hidden');

      membersGrid.querySelectorAll('.chip').forEach(ch=> ch.draggable=false);
      sizeSidebar();
    }

    document.getElementById('unlockResults').addEventListener('click', ()=>{
      const pw = prompt('Enter admin password:');
      if(pw === 'ByeRobert'){
        unlocked = true;
        enterResultsMode();
        alert('Results unlocked.');
      }else{
        alert('Incorrect password.');
      }
    });

    async function revealOneRandomMember(){
      if(!unlocked) return alert('Unlock results first.');
      if(revealed.size === TEAM_MEMBERS.length){
        showNextBtn.disabled = true;
        showNextBtn.textContent = 'All results revealed';
        return;
      }

      const remaining = TEAM_MEMBERS.filter(n => !revealed.has(n));
      const pick = remaining[Math.floor(Math.random()*remaining.length)];

      const q = await db.collection('assignments').where('member','==',pick).get();
      const counts = new Map();
      q.forEach(doc=>{
        const t = (doc.data().title||'').trim();
        if(!t) return;
        counts.set(t, (counts.get(t)||0)+1);
      });

      membersGrid.querySelectorAll('.member-box').forEach(b=> b.classList.remove('box-highlight'));

      const box = memberBoxByName.get(pick);
      if(box){
        const resWrap = box.querySelector('.result-list');
        const rows = Array.from(counts.entries())
          .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]))
          .map(([title,cnt])=> `<div class="title-count"><span>${title}</span><span>x${cnt}</span></div>`)
          .join('') || '<div class="small">No assignments yet.</div>';

        resWrap.innerHTML = `<h4>Assigned Titles</h4>${rows}`;
        resWrap.classList.remove('hidden');
        box.classList.add('box-highlight');
      }

      revealed.add(pick);

      if(revealed.size === TEAM_MEMBERS.length){
        showNextBtn.disabled = true;
        showNextBtn.textContent = 'All results revealed';
      }
    }
    showNextBtn.addEventListener('click', revealOneRandomMember);

    // Clear all data
    clearAllBtn.addEventListener('click', async ()=>{
      const pw = prompt('Enter password to CLEAR ALL data:');
      if(pw !== 'ByeRobert') return alert('Incorrect password.');
      if(!confirm('This will permanently delete ALL titles and assignments. Continue?')) return;

      async function deleteCollection(name){
        const snap = await db.collection(name).get();
        const batch = db.batch();
        let count=0;
        snap.forEach(doc=>{ batch.delete(doc.ref); count++; });
        if(count>0) await batch.commit();
        return count;
      }

      try{
        let total = 0;
        total += await deleteCollection('assignments');
        total += await deleteCollection('titles');
        alert('All data purged. Deleted docs: '+total);

        revealed.clear();
        showNextBtn.disabled = false;
        showNextBtn.textContent = 'Next Member Result';
        sidebar.classList.remove('hidden');
        layout.classList.remove('full');
        unlockBtn.classList.remove('hidden');
        submitAssignBtn.classList.remove('hidden');
        resultsMode = false;

        renderMembers();
        await loadTitles();
      }catch(err){
        console.error(err);
        alert('Error clearing data: ' + err.message);
      }
    });

    // Init
    renderMembers();
    loadTitles();
  </script>
</body>
</html>
